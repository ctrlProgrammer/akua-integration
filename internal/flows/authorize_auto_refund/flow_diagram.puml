@startuml Authorize Auto Refund Flow

title Authorization Flow - Auto Capture and Refund

skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam backgroundColor #FAFAFA

actor "Test Function" as Test
participant "InitializePaymentFlow" as InitFlow
participant "akua.Client" as Client
participant "AuthorizationProvider" as AuthProvider
participant "PaymentsProvider" as PaymentsProvider
participant "Akua API" as AkuaAPI

== Phase 1: Initialization ==
Test -> InitFlow: InitializePaymentFlow(ctx)
activate InitFlow

InitFlow -> InitFlow: InitializeEnvVariables()\nLoad .env file
InitFlow -> Client: NewClient()
activate Client
Client -> Client: Load environment variables:\n- AKUA_CLIENT_ID\n- AKUA_CLIENT_SECRET\n- AKUA_AUDIENCE\n- AKUA_ORGANIZATION_ID\n- AKUA_COMMERCE_ID
Client -> Client: Validate all env vars are set
Client --> InitFlow: *Client (or error)
deactivate Client

alt Client Creation Failed
    InitFlow --> Test: Return Error
    deactivate InitFlow
    Test --> Test: t.Fatal(err)
else Client Created Successfully
    InitFlow -> Client: LoadJwtToken()
    activate Client
    
    Client -> Client: Prepare OAuth request body
    Client -> AkuaAPI: POST /oauth/token
    activate AkuaAPI
    
    alt JWT Token Request Failed
        AkuaAPI --> Client: Error Response
        Client --> InitFlow: Return Error
        deactivate Client
        deactivate AkuaAPI
        InitFlow --> Test: Return Error
        deactivate InitFlow
        Test --> Test: t.Fatal(err)
    else JWT Token Success
        AkuaAPI --> Client: 201 Created\n{access_token, ...}
        deactivate AkuaAPI
        Client -> Client: Store access_token
        Client --> InitFlow: JWT Token loaded
        deactivate Client
    end
    
    InitFlow -> InitFlow: NewAuthorizationProvider()
    InitFlow -> InitFlow: NewPaymentsProvider()
    InitFlow --> Test: Return (client, authProvider, paymentsProvider, nil)
    deactivate InitFlow
end

== Phase 2: Authorization Request (Auto Capture) ==
Test -> Test: Prepare AuthorizeRequest:\n- Amount: {Currency: "USD", Value: 100}\n- Intent: "authorization"\n- MerchantId: client.GetMerchantId()\n- Capture.Mode: "AUTOMATIC"\n- Instrument: Card details
activate Test

Test -> AuthProvider: Authorize(ctx, client, request)
activate AuthProvider

AuthProvider -> Client: JwtIsValid()
activate Client
Client --> AuthProvider: true/false
deactivate Client

alt JWT Token Invalid
    AuthProvider --> Test: Error: ErrJWTTokenNotSet
    deactivate AuthProvider
    Test --> Test: t.Fatal(err)
else JWT Token Valid
    AuthProvider -> AuthProvider: json.Marshal(requestData)
    AuthProvider -> Client: GetAudience()
    activate Client
    Client --> AuthProvider: audience URL
    deactivate Client
    
    AuthProvider -> AuthProvider: Create HTTP POST Request\nPOST {audience}/v1/authorizations
    AuthProvider -> AuthProvider: Generate Idempotency-Key\n(amount.value + timestamp.UnixNano())
    AuthProvider -> AuthProvider: Set Headers:\n- Authorization: Bearer {token}\n- Idempotency-Key: {key}\n- Content-Type: application/json
    
    AuthProvider -> Client: GetHttpClient()
    activate Client
    Client --> AuthProvider: *http.Client
    deactivate Client
    
    AuthProvider -> AkuaAPI: POST /v1/authorizations\n{requestBody with capture.mode=AUTOMATIC}
    activate AkuaAPI
    
    alt Authorization Failed
        AkuaAPI --> AuthProvider: Error Response (400/500/etc.)
        AuthProvider --> Test: Return Error
        deactivate AkuaAPI
        deactivate AuthProvider
        Test --> Test: t.Fatal(err)
    else Authorization Success
        AkuaAPI --> AuthProvider: 201 Created\nAuthorization Response\n{payment_id, transaction: {status: "APPROVED", ...}}\n\nNote: With AUTOMATIC capture,\nauthorization and capture happen\nin the same request
        deactivate AkuaAPI
        
        AuthProvider -> AuthProvider: json.Unmarshal(response)
        AuthProvider --> Test: Return *Authorization\n{PaymentID, Transaction.Status: "APPROVED"}
        deactivate AuthProvider
        
        Test -> Test: Assert:\n- authorization != nil\n- authorization.PaymentID != nil
    end
end

== Phase 3: Verify Payment State (Before Refund) ==
Test -> PaymentsProvider: GetPaymentById(ctx, client, paymentID)
activate PaymentsProvider

PaymentsProvider -> Client: JwtIsValid()
activate Client
Client --> PaymentsProvider: true
deactivate Client

PaymentsProvider -> Client: GetAudience()
activate Client
Client --> PaymentsProvider: audience URL
deactivate Client

PaymentsProvider -> PaymentsProvider: Create HTTP GET Request\nGET {audience}/v1/payments/{paymentId}
PaymentsProvider -> PaymentsProvider: Set Headers:\n- Authorization: Bearer {token}\n- Content-Type: application/json

PaymentsProvider -> Client: GetHttpClient()
activate Client
Client --> PaymentsProvider: *http.Client
deactivate Client

PaymentsProvider -> AkuaAPI: GET /v1/payments/{paymentId}
activate AkuaAPI

AkuaAPI --> PaymentsProvider: 200 OK\nPayment Response:\n{\n  id: payment_id,\n  status: "AUTHORIZED",\n  capture.mode: "AUTOMATIC",\n  transactions: [\n    {type: "AUTHORIZATION", status: "APPROVED", ...}\n  ]\n}\n\nNote: Status may be "AUTHORIZED"\nor "CAPTURED" depending on timing\nof automatic capture
deactivate AkuaAPI

PaymentsProvider -> PaymentsProvider: json.Unmarshal(response)
PaymentsProvider --> Test: Return *Payment\n{Status: "AUTHORIZED", Capture.Mode: "AUTOMATIC"}
deactivate PaymentsProvider

Test -> Test: Assert:\n- payment.Capture.Mode == "AUTOMATIC"\n- payment.Status == "AUTHORIZED"\n- payment.Transactions.length >= 1\n- payment.Transactions[0].Type == "AUTHORIZATION"

== Phase 4: Refund Request ==
Test -> Test: Prepare Refund:\nCall Refund(ctx, client, paymentID)
activate Test

Test -> AuthProvider: Refund(ctx, client, paymentID)
activate AuthProvider

AuthProvider -> Client: JwtIsValid()
activate Client
Client --> AuthProvider: true
deactivate Client

AuthProvider -> Client: GetAudience()
activate Client
Client --> AuthProvider: audience URL
deactivate Client

AuthProvider -> AuthProvider: Create HTTP POST Request\nPOST {audience}/v1/payments/{paymentId}/refund
AuthProvider -> AuthProvider: Generate Idempotency-Key\n(paymentID + timestamp.UnixNano())
AuthProvider -> AuthProvider: Set Headers:\n- Authorization: Bearer {token}\n- Idempotency-Key: {key}\n- Content-Type: application/json

AuthProvider -> Client: GetHttpClient()
activate Client
Client --> AuthProvider: *http.Client
deactivate Client

AuthProvider -> AkuaAPI: POST /v1/payments/{paymentId}/refund
activate AkuaAPI

alt Refund Failed
    AkuaAPI --> AuthProvider: Error Response
    AuthProvider --> Test: Return Error
    deactivate AkuaAPI
    deactivate AuthProvider
    Test --> Test: t.Fatal(err)
else Refund Success
    AkuaAPI --> AuthProvider: 200 OK / 201 Created\nRefund Response\n{\n  payment_id: payment_id,\n  transaction: {\n    type: "REFUND",\n    status: "REFUNDED",\n    id: transaction_id,\n    amount: amount\n  }\n}
    deactivate AkuaAPI
    
    AuthProvider -> AuthProvider: json.Unmarshal(response)
    AuthProvider --> Test: Return *RefundResponse\n{PaymentId, Transaction.Status: "REFUNDED"}
    deactivate AuthProvider
    
    Test -> Test: Log refund response details:\n- Refund ID (PaymentId)\n- Refund Status\n- Refund Amount
end

== Phase 5: Verify Final Payment State (After Refund) ==
Test -> PaymentsProvider: GetPaymentById(ctx, client, paymentID)
activate PaymentsProvider

PaymentsProvider -> Client: JwtIsValid()
activate Client
Client --> PaymentsProvider: true
deactivate Client

PaymentsProvider -> PaymentsProvider: Create HTTP GET Request\nGET {audience}/v1/payments/{paymentId}
PaymentsProvider -> PaymentsProvider: Set Headers

PaymentsProvider -> Client: GetHttpClient()
activate Client
Client --> PaymentsProvider: *http.Client
deactivate Client

PaymentsProvider -> AkuaAPI: GET /v1/payments/{paymentId}
activate AkuaAPI

AkuaAPI --> PaymentsProvider: 200 OK\nFinal Payment Response:\n{\n  id: payment_id,\n  status: "REFUNDED",\n  capture.mode: "AUTOMATIC",\n  transactions: [\n    {type: "AUTHORIZATION", status: "APPROVED", ...},\n    {type: "CAPTURE", status: "CAPTURED", ...},\n    {type: "REFUND", status: "REFUNDED", ...}\n  ]\n}\n\nNote: Transactions include:\n- AUTHORIZATION (auto-captured)\n- CAPTURE (automatic)\n- REFUND
deactivate AkuaAPI

PaymentsProvider -> PaymentsProvider: json.Unmarshal(response)
PaymentsProvider --> Test: Return *Payment\nwith transactions:\n- AUTHORIZATION transaction\n- CAPTURE transaction (automatic)\n- REFUND transaction
deactivate PaymentsProvider

Test -> Test: Verify Final State:\n- payment.Transactions.length >= 2\n- payment.Transactions includes "AUTHORIZATION"\n- payment.Transactions includes "CAPTURE"\n- payment.Transactions includes "REFUND"\n- payment.Status == "REFUNDED"

Test -> Test: Assert:\n- lastPaymentState.Status == "REFUNDED"\n(expected payment status to be REFUNDED)

note right of Test
    **Key Points of Auto Refund Flow:**
    1. Authorization with AUTOMATIC capture mode
    2. Payment is automatically captured during authorization
    3. Payment has status "AUTHORIZED" after authorization\n   (may show CAPTURED depending on timing)
    4. Refund is applied to a captured payment
    5. Payment has multiple transactions after refund:
       - AUTHORIZATION transaction (status: APPROVED)
       - CAPTURE transaction (status: CAPTURED, automatic)
       - REFUND transaction (status: REFUNDED)
    6. Final payment status is "REFUNDED"
    7. Refund returns money to the customer for\n   a previously captured payment
end note

@enduml

